{% extends "base.html" %}

{% block title %}é£ä¹¦æ•°æ®çœ‹æ¿{% endblock %}
{% block page_title %}é£ä¹¦åœ¨çº¿è¡¨æ ¼ BI çœ‹æ¿{% endblock %}

{% block content %}
<!-- KPI Cards -->
<section class="kpi-grid">
    <div class="kpi-card">
        <div class="icon-box orders-icon">ğŸ’°</div>
        <div class="kpi-content">
            <h3>æ€»é”€å”®é¢ (Revenue)</h3>
            <p class="kpi-value" id="feishu-sales">--</p>
        </div>
    </div>
    <div class="kpi-card">
        <div class="icon-box time-icon">ğŸ‘¥</div>
        <div class="kpi-content">
            <h3>æ€»è®¿å®¢æ•° (Visitors)</h3>
            <p class="kpi-value" id="feishu-visitors">--</p>
        </div>
    </div>
    <div class="kpi-card">
        <div class="icon-box warehouse-icon">ğŸ›’</div>
        <div class="kpi-content">
            <h3>æ”¯ä»˜è®¢å•æ•° (Orders)</h3>
            <p class="kpi-value" id="feishu-orders">--</p>
        </div>
    </div>
</section>

<!-- Trend Chart -->
<section class="charts-grid upper-charts">
    <div class="chart-container large">
        <div class="chart-header">
            <h2>ğŸ“ˆ æµé‡ä¸è¥æ”¶è¶‹åŠ¿ (é£ä¹¦å®æ—¶æ•°æ®)</h2>
        </div>
        <div id="feishuTrendChart" class="chart-canvas"></div>
    </div>
</section>

<!-- Funnel & Service -->
<section class="charts-grid lower-charts">
    <div class="chart-container">
        <div class="chart-header">
            <h2>ğŸ”» è½¬åŒ–æ¼æ–— (è®¿å®¢â†’åŠ è´­â†’æ”¯ä»˜)</h2>
        </div>
        <div id="feishuFunnelChart" class="chart-canvas"></div>
    </div>
    <div class="chart-container">
        <div class="chart-header">
            <h2>â±ï¸ æœåŠ¡æŒ‡æ ‡ç›‘æ§</h2>
        </div>
        <div id="feishuServiceChart" class="chart-canvas"></div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    async function fetchData(url) {
        try {
            const response = await fetch(url);
            return await response.json();
        } catch (error) {
            console.error('Fetch error:', error);
            return null;
        }
    }

    document.addEventListener('DOMContentLoaded', async function () {
        // 1. Load KPIs
        const overview = await fetchData('/api/feishu/overview');
        if (overview && !overview.error) {
            document.getElementById('feishu-sales').textContent = `Â¥${overview.total_sales.toLocaleString()}`;
            document.getElementById('feishu-visitors').textContent = overview.total_visitors.toLocaleString();
            document.getElementById('feishu-orders').textContent = overview.total_orders.toLocaleString();
        }

        // 2. Load Trend Chart
        const trend = await fetchData('/api/feishu/trend');
        if (trend && trend.length > 0) {
            const chart = echarts.init(document.getElementById('feishuTrendChart'));
            chart.setOption({
                tooltip: { trigger: 'axis' },
                legend: { data: ['é”€å”®é¢', 'è®¿å®¢æ•°'] },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'category', data: trend.map(item => item.date) },
                yAxis: [
                    { type: 'value', name: 'é”€å”®é¢ (å…ƒ)', position: 'left' },
                    { type: 'value', name: 'è®¿å®¢æ•° (äºº)', position: 'right' }
                ],
                series: [
                    {
                        name: 'é”€å”®é¢', type: 'line', smooth: true, yAxisIndex: 0,
                        data: trend.map(item => item.sales),
                        itemStyle: { color: '#ef4444' },
                        areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(239,68,68,0.5)' }, { offset: 1, color: 'rgba(239,68,68,0.05)' }]) }
                    },
                    {
                        name: 'è®¿å®¢æ•°', type: 'bar', yAxisIndex: 1,
                        data: trend.map(item => item.visitors),
                        itemStyle: { color: '#3b82f6', opacity: 0.3 }
                    }
                ]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // 3. Load Funnel Chart
        const funnel = await fetchData('/api/feishu/funnel');
        if (funnel && !funnel.error) {
            const chart = echarts.init(document.getElementById('feishuFunnelChart'));
            chart.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    name: 'å…¨åº—è½¬åŒ–æ¼æ–—', type: 'funnel', left: '10%', width: '80%', sort: 'descending',
                    label: { show: true, position: 'inside', formatter: '{b}: {c}' },
                    data: [
                        { value: funnel.visitors, name: 'è®¿å®¢' },
                        { value: funnel.cart, name: 'åŠ è´­' },
                        { value: funnel.orders, name: 'æ”¯ä»˜è®¢å•' }
                    ]
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // 4. Load Service Metrics (Gauge)
        const service = await fetchData('/api/feishu/service');
        if (service && !service.error) {
            const chart = echarts.init(document.getElementById('feishuServiceChart'));
            chart.setOption({
                series: [{
                    type: 'gauge', startAngle: 180, endAngle: 0, min: 0, max: 240,
                    axisLine: { lineStyle: { width: 30, color: [[0.2, '#10b981'], [0.5, '#3b82f6'], [1, '#ef4444']] } },
                    pointer: { itemStyle: { color: 'auto' } },
                    detail: { formatter: '{value}å°æ—¶', fontSize: 20 },
                    title: { show: true, offsetCenter: [0, '40%'], textStyle: { fontSize: 14 } },
                    data: [{ value: service.logistics_hours, name: 'ç‰©æµå¹³å‡æ—¶æ•ˆ' }]
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }
    });
</script>
{% endblock %}