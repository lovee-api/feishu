{% extends "base.html" %}

{% block title %}é”€å”®ä¸è½¬æ¢æ¼æ–—{% endblock %}
{% block page_title %}æµé‡ä¸é”€å”®åˆ†æ{% endblock %}

{% block content %}
<!-- Finance KPIs -->
<section class="kpi-grid">
    <div class="kpi-card">
        <div class="icon-box orders-icon">ğŸ’°</div>
        <div class="kpi-content">
            <h3>æ€»é”€å”®é¢ (Revenue)</h3>
            <p class="kpi-value" id="sales-total">--</p>
        </div>
    </div>
    <div class="kpi-card">
        <div class="icon-box time-icon">ğŸ‘¥</div>
        <div class="kpi-content">
            <h3>æ€»è®¿å®¢æ•° (Visitors)</h3>
            <p class="kpi-value" id="sales-visitors">--</p>
        </div>
    </div>
    <div class="kpi-card">
        <div class="icon-box warehouse-icon">ğŸ›’</div>
        <div class="kpi-content">
            <h3>æ”¯ä»˜è®¢å•æ•° (Orders)</h3>
            <p class="kpi-value" id="sales-orders">--</p>
        </div>
    </div>
</section>

<!-- Deep Dive Charts -->
<section class="charts-grid upper-charts">
    <div class="chart-container large">
        <div class="chart-header">
            <h2>æµé‡ä¸è¥æ”¶è¶‹åŠ¿ (åŒè½´åˆ†æ)</h2>
        </div>
        <div id="salesTrendChart" class="chart-canvas"></div>
    </div>
</section>

<section class="charts-grid lower-charts">
    <div class="chart-container">
        <div class="chart-header">
            <h2>è½¬åŒ–æ¼æ–— (è®¿å®¢ -> åŠ è´­ -> æ”¯ä»˜)</h2>
        </div>
        <div id="funnelChart" class="chart-canvas"></div>
    </div>
    <div class="chart-container">
        <div class="chart-header">
            <h2>ç”¨æˆ·æ€§åˆ«åˆ†å¸ƒ</h2>
        </div>
        <div id="demographicsChart" class="chart-canvas"></div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/dashboard.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // We reuse some functions but add new ones for Funnel
        fetchSalesData();
        renderDemographicsChart();
        fetchFunnelData();
    });

    async function fetchFunnelData() {
        // Real API: /api/sales/funnel
        const data = await fetchData('/api/sales/funnel');
        if (data) {
            const chart = echarts.init(document.getElementById('funnelChart'));
            chart.setOption({
                tooltip: { trigger: 'item' },
                legend: { data: ['è®¿å®¢', 'åŠ è´­', 'æ”¯ä»˜è®¢å•'] },
                series: [{
                    name: 'å…¨åº—è½¬åŒ–æ¼æ–—', type: 'funnel', left: '10%', width: '80%',
                    sort: 'descending',
                    label: { show: true, position: 'inside', formatter: '{b}: {c}' },
                    data: [
                        { value: data.visitors, name: 'è®¿å®¢' },
                        { value: data.cart, name: 'åŠ è´­' },
                        { value: data.orders, name: 'æ”¯ä»˜è®¢å•' }
                    ]
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }
    }
</script>
{% endblock %}