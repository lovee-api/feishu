{% extends "base.html" %}

{% block title %}æœåŠ¡ä¸ç•™å­˜{% endblock %}
{% block page_title %}æœåŠ¡è´¨é‡ä¸å®¢æˆ·ç•™å­˜{% endblock %}

{% block content %}
<section class="kpi-grid">
    <div class="kpi-card">
        <div class="icon-box" style="background:#e0e7ff; color:#4f46e5;">ğŸ’¬</div>
        <div class="kpi-content">
            <h3>å®¢æœå¹³å‡å“åº”æ—¶é•¿</h3>
            <p class="kpi-value" id="svc-response">-- s</p>
        </div>
    </div>
    <div class="kpi-card">
        <div class="icon-box" style="background:#dcfce7; color:#16a34a;">ğŸšš</div>
        <div class="kpi-content">
            <h3>ç‰©æµå¹³å‡æ—¶æ•ˆ</h3>
            <p class="kpi-value" id="svc-logistics">-- h</p>
        </div>
    </div>
    <div class="kpi-card">
        <div class="icon-box" style="background:#fee2e2; color:#dc2626;">ğŸ’¸</div>
        <div class="kpi-content">
            <h3>é€€æ¬¾å¤„ç†æ—¶é•¿</h3>
            <p class="kpi-value" id="svc-refund">-- å¤©</p>
        </div>
    </div>
</section>

<section class="charts-grid lower-charts">
    <div class="chart-container">
        <div class="chart-header">
            <h2>ä¼šå‘˜ç­‰çº§åˆ†å¸ƒ (æ–°è€å®¢å æ¯”)</h2>
        </div>
        <!-- Placeholder: Actually this chart is confusingly named 'userChart' in JS but used for Tier Distribution -->
        <div id="userChart" class="chart-canvas"></div>
    </div>
    <div class="chart-container">
        <div class="chart-header">
            <h2>ç‰©æµæ—¶æ•ˆç›‘æ§ (ç›®æ ‡: <48h)< /h2>
        </div>
        <div id="retentionChart" class="chart-canvas"></div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/dashboard.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Reuse UserChart for Tiers
        renderUserChart();
        fetchServiceMetrics();
    });

    async function fetchServiceMetrics() {
        const data = await fetchData('/api/service/metrics');
        if (data) {
            document.getElementById('svc-response').textContent = `${data.chat_seconds} ç§’`;
            document.getElementById('svc-logistics').textContent = `${data.logistics_hours} å°æ—¶`;
            document.getElementById('svc-refund').textContent = `${data.refund_days} å¤©`;

            // Render Retention/Gauge mock
            const chart = echarts.init(document.getElementById('retentionChart'));
            chart.setOption({
                series: [{
                    type: 'gauge',
                    startAngle: 180, endAngle: 0,
                    min: 0, max: 240,
                    itemStyle: { color: '#58D9F9' },
                    pointer: { itemStyle: { color: 'auto' } },
                    axisLine: { lineStyle: { width: 30, color: [[0.2, '#10b981'], [0.5, '#3b82f6'], [1, '#ef4444']] } },
                    detail: { formatter: '{value}å°æ—¶', fontSize: 20 },
                    title: { show: true, offsetCenter: [0, '40%'], textStyle: { fontSize: 16 } },
                    data: [{ value: data.logistics_hours, name: 'å¹³å‡è€—æ—¶' }]
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }
    }
</script>
{% endblock %}